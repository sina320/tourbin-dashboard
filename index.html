<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TORBIN Â· Ù…Ø¯ÛŒØ± ÙØ±ÙˆØ´</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <style>
        /* ===== RESET ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #f7f9fc;
            padding: 24px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .logo {
            font-size: 20px;
            font-weight: 600;
            color: #0a2c3d;
            letter-spacing: -0.3px;
        }

        .user {
            font-size: 14px;
            color: #4f6573;
            background: white;
            padding: 8px 16px;
            border-radius: 40px;
            border: 1px solid #edf2f5;
        }

        /* ===== KPI GRID ===== */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: white;
            padding: 24px;
            border-radius: 20px;
            border: 1px solid #f0f3f5;
        }

        .kpi-label {
            font-size: 13px;
            color: #5e6f7d;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 600;
            color: #0a2c3d;
            line-height: 1;
            margin-bottom: 4px;
        }

        .kpi-meta {
            font-size: 13px;
            color: #6f828c;
        }

        /* ===== PROGRESS BAR ===== */
        .progress {
            background: #edf2f5;
            height: 6px;
            border-radius: 10px;
            margin-top: 12px;
            width: 100%;
        }

        .progress-fill {
            background: #0a7c71;
            height: 6px;
            border-radius: 10px;
            width: 0%;
        }

        /* ===== ALERT ===== */
        .alert {
            background: #fff4f2;
            border-left: 5px solid #d44333;
            padding: 18px 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-icon {
            font-size: 20px;
        }

        .alert-title {
            font-weight: 600;
            color: #b33a2a;
            margin-bottom: 4px;
        }

        .alert-desc {
            font-size: 14px;
            color: #5e3a35;
        }

        /* ===== SECTION ===== */
        .section {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #f0f3f5;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #0a2c3d;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ===== TABLES ===== */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table td {
            padding: 12px 0;
            border-bottom: 1px solid #f0f5f7;
            font-size: 15px;
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .rank {
            color: #0a7c71;
            font-weight: 500;
        }

        .text-right {
            text-align: right;
        }

        .text-muted {
            color: #6f828c;
            font-size: 14px;
        }

        /* ===== LAUNCHPAD ===== */
        .launchpad {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .launch-item {
            background: #f8fafc;
            padding: 10px 18px;
            border-radius: 40px;
            font-size: 14px;
            color: #1e3b4a;
            text-decoration: none;
            border: 1px solid #edf2f5;
            cursor: pointer;
        }

        .launch-item:hover {
            background: #edf2f5;
        }

        /* ===== UTILS ===== */
        .mt-2 { margin-top: 16px; }
        .mb-1 { margin-bottom: 8px; }
        .bold { font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ===== HEADER ===== -->
        <div class="header">
            <div class="logo">TORBIN</div>
            <div class="user" id="userInfo">ğŸ‘¤ Ù…Ø¯ÛŒØ± ÙØ±ÙˆØ´</div>
        </div>

        <!-- ===== KPI: TODAY & TARGET ===== -->
        <div class="grid-2">
            <div class="kpi-card">
                <div class="kpi-label">ğŸ’° Ø§Ù…Ø±ÙˆØ²</div>
                <div class="kpi-value" id="todaySales">â€”</div>
                <div class="kpi-meta" id="todayMeta">ØªØ§ Ø³Ø§Ø¹Øª Û¹ ØµØ¨Ø­</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">ğŸ¯ ØªØ­Ù‚Ù‚ Ù‡Ø¯Ù Ù…Ø§Ù‡</div>
                <div class="kpi-value" id="targetPercent">â€”</div>
                <div class="kpi-meta" id="targetMeta">Ø§Ø² Û±Û°Û°,Û°Û°Û° Ø¯Ù„Ø§Ø±</div>
                <div class="progress">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <!-- ===== ALERT: DIRECT SALES ZERO ===== -->
        <div id="directSalesAlert" style="display: none;" class="alert">
            <span class="alert-icon">ğŸ”´</span>
            <div>
                <div class="alert-title">ÙØ±ÙˆØ´ Ø¯Ø§ÛŒØ±Ú©Øª ØµÙØ± Ø§Ø³Øª</div>
                <div class="alert-desc">Û· Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡ Ù‡ÛŒÚ† ÙØ±ÙˆØ´ÛŒ Ø§Ø² Ø³Ø§ÛŒØª Ù†Ø¯Ø§Ø´ØªÙ‡â€ŒØ§ÛŒÙ…. Ù„ÛŒÙ†Ú© Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.</div>
            </div>
        </div>

        <!-- ===== KPI: COMMISSION & AGENTS COUNT ===== -->
        <div class="grid-2">
            <div class="kpi-card">
                <div class="kpi-label">ğŸ’¸ Ù¾ÙˆØ±Ø³Ø§Ù†Øª Ø§ÛŒÙ† Ù…Ø§Ù‡</div>
                <div class="kpi-value" id="commissionTotal">â€”</div>
                <div class="kpi-meta" id="commissionMeta">Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ AgentÙ‡Ø§</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">ğŸ‘¥ AgentÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</div>
                <div class="kpi-value" id="agentCount">â€”</div>
                <div class="kpi-meta">ÙØ±ÙˆØ´ Ù…ÙˆÙÙ‚ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø§Ù‡</div>
            </div>
        </div>

        <!-- ===== TOP AGENTS ===== -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    <span>ğŸ¥‡</span> AgentÙ‡Ø§ÛŒ Ø¨Ø±ØªØ± Ù…Ø§Ù‡
                </div>
                <span class="text-muted">Û±Û°Ùª Ù¾ÙˆØ±Ø³Ø§Ù†Øª</span>
            </div>
            <table class="table" id="agentsTable">
                <tr><td colspan="2" style="text-align: center; padding: 32px; color: #8a9ca8;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>
            </table>
        </div>

        <!-- ===== TOP OTAs ===== -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    <span>ğŸŒ</span> OTAÙ‡Ø§ (Ø®Ø§Ù„Øµ Ù¾Ø³ Ø§Ø² Ú©Ù…ÛŒØ³ÛŒÙˆÙ†)
                </div>
            </div>
            <table class="table" id="otasTable">
                <tr><td colspan="2" style="text-align: center; padding: 32px; color: #8a9ca8;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>
            </table>
        </div>

        <!-- ===== LAUNCHPAD ===== -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    <span>ğŸ”—</span> Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹
                </div>
            </div>
            <div class="launchpad">
                <div class="launch-item" onclick="window.open('https://tourbin-upload.vercel.app', '_blank')">ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ Ø¯ÛŒØªØ§</div>
                <div class="launch-item" onclick="alert('ğŸ’° Ù…Ø§Ú˜ÙˆÙ„ Ø­Ù‚ÙˆÙ‚ Ùˆ Ø¯Ø³ØªÙ…Ø²Ø¯ - Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ')">ğŸ’° Ø­Ù‚ÙˆÙ‚</div>
                <div class="launch-item" onclick="alert('ğŸ”„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¯ÛŒØªØ§ - Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ')">ğŸ”„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ</div>
                <div class="launch-item" onclick="alert('ğŸ“Š Ú¯Ø²Ø§Ø±Ø´Ø§Øª - Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ')">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´Ø§Øª</div>
            </div>
        </div>

        <!-- ===== FOOTER ===== -->
        <div style="margin-top: 32px; text-align: center; font-size: 12px; color: #8fa2ae;">
            Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span id="updateTime">â€”</span>
        </div>
    </div>

    <script>
        // ===== FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyDGomc7oZCGf8QkQq3I_SJht7GJF6pz_5c",
            authDomain: "tourbin-sales-dashboard-v2.firebaseapp.com",
            projectId: "tourbin-sales-dashboard-v2",
            storageBucket: "tourbin-sales-dashboard-v2.firebasestorage.app",
            messagingSenderId: "827092290582",
            appId: "1:827092290582:web:24e530b12858c615d13937"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);
        
        const MONTH_TARGET = 100000; // Ù‡Ø¯Ù Ù…Ø§Ù‡Ø§Ù†Ù‡: Û±Û°Û°,Û°Û°Û° Ø¯Ù„Ø§Ø±

        // ===== LOAD DATA =====
        async function loadDashboard() {
            try {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];

                const snapshot = await db.collection('sales_transactions')
                    .where('status', 'in', ['CONFIRMED', 'ARRIVED'])
                    .get();

                const transactions = [];
                snapshot.forEach(doc => transactions.push(doc.data()));

                // ===== TODAY'S SALES =====
                let todaySales = 0;
                transactions.forEach(t => {
                    if (t.report_date === todayStr) {
                        todaySales += t.total_price_usd || 0;
                    }
                });
                document.getElementById('todaySales').innerHTML = `$${todaySales.toLocaleString()}`;
                document.getElementById('todayMeta').innerHTML = `ØªØ§ Ø³Ø§Ø¹Øª ${today.getHours()}:${String(today.getMinutes()).padStart(2,'0')}`;

                // ===== MONTH SALES & TARGET =====
                let monthSales = 0, directSales = 0, commissionTotal = 0;
                let agentSales = {}, otaSales = {};

                transactions.forEach(t => {
                    if (t.report_date >= monthStart) {
                        const price = t.total_price_usd || 0;
                        const channel = t.channel || '';
                        const agent = t.agent_name || '';
                        
                        monthSales += price;
                        
                        if (channel === 'Direct') directSales += price;
                        
                        if (agent) {
                            agentSales[agent] = (agentSales[agent] || 0) + price;
                            commissionTotal += price * 0.1;
                        }
                        
                        if (channel?.startsWith('OTA_')) {
                            const otaName = channel.replace('OTA_', '');
                            otaSales[otaName] = (otaSales[otaName] || 0) + price;
                        }
                    }
                });

                // Target percent
                const targetPercent = Math.min(100, ((monthSales / MONTH_TARGET) * 100)).toFixed(0);
                document.getElementById('targetPercent').innerHTML = `${targetPercent}%`;
                document.getElementById('targetMeta').innerHTML = `Ø§Ø² $${MONTH_TARGET.toLocaleString()}`;
                document.getElementById('progressFill').style.width = `${targetPercent}%`;

                // Commission & Agents
                document.getElementById('commissionTotal').innerHTML = `$${commissionTotal.toLocaleString()}`;
                document.getElementById('commissionMeta').innerHTML = `Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ ${Object.keys(agentSales).length} Agent`;
                document.getElementById('agentCount').innerHTML = Object.keys(agentSales).length;

                // ===== DIRECT SALES ALERT =====
                if (directSales === 0) {
                    document.getElementById('directSalesAlert').style.display = 'flex';
                } else {
                    document.getElementById('directSalesAlert').style.display = 'none';
                }

                // ===== TOP AGENTS =====
                updateAgentsTable(agentSales);
                
                // ===== TOP OTAs =====
                updateOTAsTable(otaSales);

                // ===== UPDATE TIME =====
                const now = new Date();
                document.getElementById('updateTime').innerHTML = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ===== AGENTS TABLE =====
        function updateAgentsTable(agentSales) {
            const tbody = document.getElementById('agentsTable');
            const sorted = Object.entries(agentSales)
                .map(([name, sales]) => ({ name, sales }))
                .sort((a, b) => b.sales - a.sales)
                .slice(0, 5);

            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 32px; color: #8a9ca8;">Ù‡ÛŒÚ† ÙØ±ÙˆØ´ÛŒ Ø§Ø² AgentÙ‡Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</td></tr>';
                return;
            }

            let html = '';
            sorted.forEach((agent, i) => {
                const rank = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i+1}.`;
                html += `<tr>
                    <td><span class="rank">${rank}</span> ${agent.name}</td>
                    <td class="text-right bold">$${agent.sales.toLocaleString()}</td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        // ===== OTAs TABLE =====
        function updateOTAsTable(otaSales) {
            const tbody = document.getElementById('otasTable');
            const sorted = Object.entries(otaSales)
                .map(([name, sales]) => ({ name, sales }))
                .sort((a, b) => b.sales - a.sales)
                .slice(0, 5);

            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 32px; color: #8a9ca8;">Ù‡ÛŒÚ† ÙØ±ÙˆØ´ÛŒ Ø§Ø² OTAÙ‡Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</td></tr>';
                return;
            }

            let html = '';
            sorted.forEach((ota, i) => {
                const net = ota.sales * 0.75; // Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Û²ÛµÙª Ú©Ù…ÛŒØ³ÛŒÙˆÙ†
                html += `<tr>
                    <td>${i+1}. ${ota.name}</td>
                    <td class="text-right bold">$${net.toLocaleString()}</td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        // ===== INIT =====
        window.onload = () => {
            loadDashboard();
            setInterval(loadDashboard, 300000); // Ù‡Ø± Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡
        };
    </script>
</body>
</html>
